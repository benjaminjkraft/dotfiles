#!/bin/bash

git status
echo

add_diffs () {
    while read line; do
        sha="$(echo "$line" | sed 's/\x1b\[[0-9;]*m//g' | cut -d ' ' -f1)"
        # modified from https://unix.stackexchange.com/a/575354 and
        # https://gist.github.com/egmontkob/eb114294efbcd5adb1944c9f3cb5feda
        # the hyperlink magic that will work in screen is:
        # \eP\e]8;;<url>\a<text>\eP\e]8;;\a\e\
        diff="$(git rev-list --max-count=1 --format=%B "$sha" | grep -e "Differential Revision:" -e "Issue:" | sort | sed 's_^[^:]*: \(.*/\)\([^/]*\)$_\x1bP\x1b]8;;\1\2\a\2\x1b\P\x1b]8;;\a\x1b\\_' | paste -d',' -s - | sed 's/,/, /')"
        if [ -n "$diff" ]; then
            echo "$line ($diff)"
        else
            echo "$line"
        fi
    done
}

for head in origin/HEAD origin/master ; do
    if git rev-parse "$head" &>/dev/null; then
        git log --oneline "$head.." -n 10 --color | add_diffs
        break
    fi
done
echo

git diff --stat
