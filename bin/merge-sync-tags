#!/bin/bash

# TODO: put the sed script inline, avoid SOURCE garbage
# TODO: document

# get real source file
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do
  DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"

# get ka-root (if we're in one)
KA_ROOT="$PWD"
while [ "$KA_ROOT" != "/" ] && ! [ -f "$KA_ROOT/.ka_root" ]; do
    KA_ROOT="$(dirname "$PWD")"
done

if [ "$#" -gt 0 ]; then
    files=("$@")
else
    files=()
    while read -r -d ''; do
        files+=("$REPLY")
    done < <(git diff -z --name-only --diff-filter=U)
fi

# TODO: use ancesdir instead, to avoid needing ka-root?
if [ "$KA_ROOT" != "/" ]; then
    # run sed script (over arguments, or unmerged files if unspecified)
    sed -Esi -f "$DIR/_merge-sync-tags.sed" "${files[@]}"

    # figure out how to fix up the sync tags
    lint="$("$KA_ROOT/tools/runlint.py" -l "$KA_ROOT/dev/linters/code_syncing_lint.py")"
    # actually fix them up
    echo -n "$lint" | sed -e 's/.*running: //' -e 's/ (dev.linters.*//' | sh -x

    # check if that solved all our problems
    if echo -n "$lint" | grep -q "appears to be malformed" || grep -q '[<>|=]{7}'; then
        echo "unable to resolve all conflicts :("
        exit 1
    fi

    # we were able to resolve all conflicts
    # print the diff, for the user's inspection
    git diff

    read -p "Look good [y]? " -n 1 -r
    echo

    if [[ $REPLY =~ ^[yY]*$ ]]; then
        git add "${files[@]}"
        exit 0
    fi
fi

exit 1
